(()=>{"use strict";var e,t={624:(e,t,r)=>{function i(e,t){let r=oe.createShader(e);return oe.shaderSource(r,t),oe.compileShader(r),oe.getShaderParameter(r,oe.COMPILE_STATUS)||(console.log(oe.getShaderInfoLog(r)),oe.deleteShader(r)),r}function n(e,t,r,i,n,o){const s=oe.createTexture();return oe.bindTexture(oe.TEXTURE_2D,s),null==o&&(o=n===oe.UNSIGNED_BYTE?new Uint8Array(e*t*4).fill(0):new Float32Array(e*t*4).fill(0)),oe.texImage2D(oe.TEXTURE_2D,0,r,e,t,0,i,n,o),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MIN_FILTER,oe.NEAREST),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MAG_FILTER,oe.NEAREST),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_S,oe.CLAMP_TO_EDGE),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_T,oe.CLAMP_TO_EDGE),s}r.d(t,{l2:()=>se,gl:()=>oe,fu:()=>ae,ju:()=>le});class o{constructor(e,t,r=1,i,o,s){const a="object"==typeof r,l=a?r.length:r;this.textures=[];for(let u=0;u<l;u++)this.textures.push(n(e,t,i,o,s,a?r[u]:null));this.framebuffer=function(e){const t=oe.createFramebuffer();oe.bindFramebuffer(oe.FRAMEBUFFER,t);for(let[t,r]of Object.entries(e))t=Number.parseInt(t),oe.framebufferTexture2D(oe.FRAMEBUFFER,oe.COLOR_ATTACHMENT0+t,oe.TEXTURE_2D,r,0);return t}(this.textures),this.texture=this.textures[0]}}class s{constructor(e,t,r=1,i=oe.RGBA32F,n=oe.RGBA,s=oe.FLOAT){this.width=e,this.height=t,this.renderTargets="object"==typeof r?r.length:r,this.format=n,this.type=s,this.fbo=new o(e,t,r,i,n,s),this.fbo1=new o(e,t,r,i,n,s)}getCurrentFBO(){return this.fbo.framebuffer}getRenderTexture(e){return null!=e?this.fbo.textures[e]:this.fbo.texture}getCurrentTexture(e){return null!=e?this.fbo1.textures[e]:this.fbo1.texture}swap(){let e=this.fbo;this.fbo=this.fbo1,this.fbo1=e}}const a={width:24,height:24,uLevelStart:[1,1],uLevelFinish:[22,22]},l={renderWidth:768,renderHeight:768,uSamples:45,uMaxSteps:30,uFrameBlend:.8,uLightAngle:.8,uShadows:!0,uShadowsFalloff:.25,uLighting:1,uAmbientLight:.005,uAO:!0,uAORange:[0,2],uHueOffset:.1,uSaturation:1,stateUpdateFrequency:50},u={uColor:[1,1,1],uEmission:1,uState:0,uDrawMode:0,uLevelStartFinishMode:0,uBlockHighlightAnimation:0},c={...l,...a,uPlayerData:[3,3,.5,.5],uPlayerColor:[1,1,1],uSourceActive:!1,uWireSource:[-1,-1],uWireActivationAnimation:0,...u},h="/GI-Playground",d="levels";class f{constructor(e){this.name=e,this.value=c[e]}getType(e){if("object"==typeof e){if(2==e.length)return"uniform2fv";if(3==e.length)return"uniform3fv";if(4==e.length)return"uniform4fv";throw new Error("Invalid uniform value: "+JSON.stringify(e))}return"boolean"==typeof e?"uniform1i":"uniform1f"}update(e,t){null!=e&&(this.value=e),null!=t&&null!=this.value&&(this.loc=oe.getUniformLocation(t.program,this.name),null!=this.loc&&oe[this.getType(this.value)](this.loc,this.value))}}class v{constructor({vertexSource:e="#version 300 es\r\n\r\nout vec2 uv;\r\n\r\nvoid main() {\r\n    // https://www.saschawillems.de/blog/2016/08/13/vulkan-tutorial-on-rendering-a-fullscreen-quad-without-buffers/\r\n    uv = vec2((gl_VertexID << 1) & 2, gl_VertexID & 2);\r\n    gl_Position = vec4(uv * 2. - 1., 0, 1);\r\n}",fragmentSource:t,framebuffer:r=null,textures:n={}}={}){const o=i(oe.VERTEX_SHADER,e),s=i(oe.FRAGMENT_SHADER,t);if(this.program=function(e,t){let r=oe.createProgram();return oe.attachShader(r,e),oe.attachShader(r,t),oe.linkProgram(r),oe.getProgramParameter(r,oe.LINK_STATUS)||(console.log(oe.getProgramInfoLog(r)),oe.deleteProgram(r)),r}(o,s),this.uniforms=this.extractUniformsFromShaderSource(t),this.textures=n,this.fbo=r,!oe.getProgramParameter(this.program,oe.LINK_STATUS))throw new Error("An error happened during the program compilation")}exec(){oe.useProgram(this.program);const e=this.fbo?this.fbo.width:oe.canvas.width,t=this.fbo?this.fbo.height:oe.canvas.height;if(oe.viewport(0,0,e,t),oe.bindFramebuffer(oe.FRAMEBUFFER,this.fbo?this.fbo.getCurrentFBO():null),this.fbo&&2==this.fbo.renderTargets)oe.drawBuffers([oe.COLOR_ATTACHMENT0,oe.COLOR_ATTACHMENT1]);else if(this.fbo&&1==this.fbo.renderTargets)oe.drawBuffers([oe.COLOR_ATTACHMENT0]);else{if(this.fbo)throw new Error("Not implemented");oe.drawBuffers([oe.BACK])}for(let r of this.uniforms)"iResolution"===r.name?r.update([e,t],this):r.update(null,this);let r=0;for(let e in this.textures){let t=this.textures[e];t.getCurrentTexture&&(t=t.getCurrentTexture()),oe.uniform1i(oe.getUniformLocation(this.program,e),r),oe.activeTexture(oe.TEXTURE0+r),oe.bindTexture(oe.TEXTURE_2D,t),r++}oe.clearColor(0,0,0,0),oe.clear(oe.COLOR_BUFFER_BIT),oe.drawArrays(oe.TRIANGLES,0,3)}extractUniformsFromShaderSource(e){return e.split(";").map((e=>e.trim())).filter((e=>e.includes("uniform ")&&!e.startsWith("///"))).map((e=>e.slice(e.indexOf("uniform ")).split(" ").slice(1))).filter((([e])=>"sampler2D"!==e)).map((([e,t])=>{if(Object.keys(se.uniforms).includes(t))return se.uniforms[t];const r=new f(t);return se.uniforms[t]=r,r}))}}var m=r(641),g=r(885);function p(e,t,r){return Math.min(Math.max(e,t),r)}function y(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function b(e){const t=e/1e3,r=(e%1e3).toString().padStart(3,"0"),i=Math.floor(t/60).toString().padStart(2,"0");return`${i}:${Math.floor(t-60*i).toString().padStart(2,"0")}'${r}`}function x(){return window.location.search.split("=")[1]}class w{constructor(){this.gui=new m.guify({title:"2d GI Playground by @kishimisu",theme:"dark",align:"right",width:300,barMode:"none",panelOverflowBehavior:"scroll",open:!0}),this.isFocusingInputField=!1,this.init(),document.getElementsByClassName("back-btn")[0].onclick=()=>{window.location.assign(h+"/")},Object.values(document.getElementsByClassName("btn-try-again")).forEach((e=>e.onclick=()=>{this.setGameOver(!1),ae.reset()})),this.isPublishing=!1,document.getElementById("btn-publish-score").onclick=async()=>{if(this.isPublishing)return;const e=document.getElementById("new-score-author").value;if(null==e||""==e.trim())return void alert("Please enter your name!");this.isPublishing=!0;await ae.updateHighscores(e.trim());this.isPublishing=!1,document.location.reload()},document.getElementById("btn-all-levels").onclick=()=>{window.location.assign(h+"/")};const e=document.getElementsByClassName("score-container")[0];this.resizeLeftPanels=()=>{const t=se.canvas.getBoundingClientRect();if(se.editorMode){document.getElementsByClassName("info-editor")[0].style.width=.9*t.left+"px"}else{document.getElementsByClassName("level-infos")[0].style.width=.9*t.left+"px";const r=e.getBoundingClientRect();e.style.left=Math.max(0,t.left/2-r.width/2)+"px"}},window.addEventListener("resize",(()=>this.resizeLeftPanels())),this.resizeLeftPanels();const t=document.getElementsByClassName(se.editorMode?"info-editor":"info-panel")[0];document.addEventListener("keydown",(r=>{const i=r.key.toLowerCase();if(!this.isFocusingInputField&&!ae.gameOver){if("h"===i){if(!se.editorMode){const e="hidden"!==this.gui.container.style.visibility?"hidden":"visible";this.gui.container.style.visibility=e}const r="hidden"!==t.style.visibility?"hidden":"visible";if(t.style.visibility=r,!se.editorMode){const t="hidden"!==e.style.visibility||0==ae.highscores.length?"hidden":"visible";e.style.visibility=t}}se.editorMode||("r"===i?se.level.reset():"f"===i&&(le.uBlockHighlightAnimation.update(2),this.updateBlockHighlightAnimation()))}})),t.style.visibility="visible"}init(){if(this.drawSettings=new T,this.gui.Register([...S(),...this.drawSettings.init(),...M()]),se.editorMode){const[e,t]=document.getElementsByClassName("guify-text-input"),r=()=>this.isFocusingInputField=!0,i=()=>this.isFocusingInputField=!1;e.onfocus=r,t.onfocus=r,e.onblur=i,t.onblur=i,this.drawSettings.setupColorPicker()}}initScoreboard(){if(0==ae.highscores.length)return;const e=document.getElementsByClassName("score-container")[0];for(let[n,o]of Object.entries(ae.highscores.sort(((e,t)=>e.time>t.time?1:-1)))){if(n>=9)break;const s=document.createElement("p");s.innerHTML=(t=Number.parseInt(n)+1,r=o.time,i=o.author,`<p><span class="score-rank">#${t}</span>\n                    <span class="score-time">${b(r)}</span>\n                    <span class="score-author">by ${i}</span></p>`),e.appendChild(s)}var t,r,i;this.resizeLeftPanels(),e.style.visibility="visible"}setLevelInfos(e,t){document.getElementsByClassName("level-name")[0].innerText='"'+e+'"',document.getElementsByClassName("author-name")[0].innerText="by "+t}setGameOver(e=!1,t,r){if(e){document.getElementsByClassName("game-over-panel")[0].style.visibility="visible",document.getElementsByClassName("game-over-title")[0].innerText=`Level cleared in ${b(t)}!`;const e=r?"game-over-new-score":"game-over-no-score";document.getElementsByClassName(e)[0].style.display="block"}else document.getElementsByClassName("game-over-panel")[0].style.visibility="hidden",document.getElementsByClassName("game-over-title")[0].innerText="",document.getElementsByClassName("game-over-new-score")[0].style.display="none",document.getElementsByClassName("game-over-no-score")[0].style.display="none"}updateBlockHighlightAnimation(){le.uBlockHighlightAnimation.value*=.998,le.uBlockHighlightAnimation.value>.001?setTimeout((()=>this.updateBlockHighlightAnimation())):le.uBlockHighlightAnimation.update(0)}updateTimer(e){document.getElementsByClassName("timer-container")[0].innerText=b(e)}}function S(){const e=e=>e+"x"+e,t=e=>{const t=Number.parseInt(e);se.updateRenderSize(t,t)},{renderSizes:r,currentRenderSize:i}=(()=>{const t=[],r=Math.min(ae.width,ae.height),i=se.canvas.getBoundingClientRect(),n=Math.floor(Math.min(i.width,i.height)*window.devicePixelRatio),o={value:e(768)};let s=4*r;for(;s<=n;)t.push(e(s)),s*=2;return t.push(e(n)),{renderSizes:t,currentRenderSize:o}})(),n="2d-gi-render-settings",o=["uSamples","uMaxSteps","uFrameBlend","uLighting","uShadows","uAO"],s=JSON.parse(localStorage.getItem(n));if(null!=s){for(let[e,t]of Object.entries(s))null!=le[e]&&le[e].update(t);null!=s.renderSize&&i.value!=s.renderSize&&(i.value=e(s.renderSize),t(s.renderSize))}let a=null;const u=()=>{a&&clearTimeout(a),a=setTimeout(h,1e3)},h=()=>{const e=Object.fromEntries(Object.values(le).filter((e=>o.includes(e.name))).map((e=>[e.name,e.value])));e.renderSize=Number.parseInt(i.value),localStorage.setItem(n,JSON.stringify(e))};return[B("Render Settings",!se.editorMode),_("Render Size",i,"value",r,(e=>{t(e),u()})),A("Ray Samples",le.uSamples,"value",2,128,1,u),A("Raymarch steps",le.uMaxSteps,"value",1,64,1,u),A("Frame blending",le.uFrameBlend,"value",0,1,.01,u),A("Lighting",le.uLighting,"value",.5,4,.1,u),C("Shadows",le.uShadows,"value",u),C("AO",le.uAO,"value",u),R("Reset Defaults",(()=>{for(let e of o)null!=le[e]&&null!=c[e]&&le[e].update(c[e]);const r=Math.min(l.renderWidth,l.renderHeight);i.value=e(r),t(r),h()}))]}function M(){if(!se.editorMode)return[];const e={levelName:"",levelAuthor:""};let t=!1;return[B("Publish Level",!0),k("Level Name",e,"levelName"),k("Author Name",e,"levelAuthor"),R("Publish",(async()=>{if(t)return;if(0===e.levelName.trim().length)return void alert("The level name cannot be empty");if(0===e.levelAuthor.trim().length)return void alert("The author name cannot be empty");t=!0;const r=await ae.save(e.levelName.trim(),e.levelAuthor.trim());0==r?alert("An error happened while publishing your level :("):(alert("Your level has been published!\nhttps://kishimisu.github.io/GI-Playground/game.html?id="+r),window.location.assign(h+"/game.html?id="+r)),t=!1}))]}const E=["emissive","wire","wall","background"],D=[[0,0,0],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[1,0,1],[0,1,1],[1,1,1]];class T{constructor(){this.currentMode="emissive",this.colorRects=[],this.lastModeUpdate=0,this.params={...u}}init(){return se.editorMode?[...this.addLevelEditorGUI(),...this.addLevelSettingsGUI()]:[]}addLevelSettingsGUI(){return[B("Level Settings",!0),A("Ambient Light",le.uAmbientLight,"value",0,.1,.001),A("Light Angle",le.uLightAngle,"value",0,2*Math.PI,2*Math.PI/32),A("Penumbra",le.uShadowsFalloff,"value",0,1,.01),A("Hue Offset",le.uHueOffset,"value",0,.5,.001,(()=>{this.colorRects.forEach((e=>e.updateColor()))})),A("Saturation",le.uSaturation,"value",0,1,.001),R("Set Level Start",(()=>le.uLevelStartFinishMode.update(1))),R("Set Level Finish",(()=>le.uLevelStartFinishMode.update(2))),R("Play From Start",(()=>ae.reset()))]}addLevelEditorGUI(){return[B("Level Editor",!0),C("color_picker"),R("Emissive Mode",(()=>{"wall"===this.currentMode&&this.colorRects[7].selectColorRect(),this.setDrawMode("emissive")})),R("Wire Mode",(()=>{("wall"===this.currentMode||y(le.uColor.value,[1,1,1]))&&this.colorRects[1].selectColorRect(),this.setDrawMode("wire")})),R("Wall Mode",(()=>{this.colorRects[0].selectColorRect(),this.setDrawMode("wall")})),R("Background Mode",(()=>{this.colorRects[7].selectColorRect(),this.setDrawMode("background")}))]}update(){"emissive"===this.currentMode?(le.uEmission.update(this.params.uEmission),le.uState.update(1)):"wire"===this.currentMode?(le.uEmission.update(-this.params.uEmission),le.uState.update(2)):"wall"===this.currentMode?(le.uEmission.update(0),le.uState.update(0)):"background"===this.currentMode&&(le.uEmission.update(-1e-9),le.uState.update(0)),le.uBlockHighlightAnimation.update((Date.now()-this.lastModeUpdate)/1e3),le.uDrawMode.update(E.indexOf(this.currentMode))}setDrawMode(e){if(!E.includes(e))throw new Error("Draw mode does not exist: "+e);this.highlightModeButton(e),this.currentMode=e,this.lastModeUpdate=Date.now()}setupColorPicker(){Object.values(document.getElementsByClassName("guify-component-container")).filter((e=>e.innerHTML.includes("color_picker")))[0].innerHTML='\n            <div class="guify-component-container">\n                <div class="guify-component-label">Color</div>\n            </div>\n            <div class="color-picker-row">\n                <div class="color-picker-rect"></div>\n                <div class="color-picker-rect"></div>\n                <div class="color-picker-rect"></div>\n                <div class="color-picker-rect"></div>\n            </div>\n            <div class="color-picker-row">\n                <div class="color-picker-rect"></div>\n                <div class="color-picker-rect"></div>\n                <div class="color-picker-rect"></div>\n                <div class="color-picker-rect"></div>\n            </div>';const e=Object.values(document.getElementsByClassName("color-picker-rect")),t=(t,r)=>{e.forEach((e=>e.classList.remove("color-picker-rect-selected"))),t.classList.add("color-picker-rect-selected"),le.uColor.update(r)},r=(e,t)=>{let r=function(e,t,r){let i=Math.max(e,t,r),n=i-Math.min(e,t,r),o=n&&(i==e?(t-r)/n:i==t?2+(r-e)/n:4+(e-t)/n);return[60*(o<0?o+6:o)/360,i&&n/i,i]}(...t);r[0]+=le.uHueOffset.value,r=function(e,t,r){let i=(i,n=(i+360*e/60)%6)=>r-r*t*Math.max(Math.min(n,4-n,1),0);return[i(5),i(3),i(1)]}(...r),r=function(e,t){for(let r=0;r<e.length;r++)e[r]*=t;return e}(r,255),r=function(e,t,r){return"#"+(1<<24|e<<16|t<<8|r).toString(16).slice(1)}(...r),e.style.backgroundColor=r};for(let[i,n]of Object.entries(e)){const e=D[i];r(n,e),n.onclick=()=>{t(n,e),0==i?this.setDrawMode("wall"):"wall"===this.currentMode&&this.setDrawMode("emissive")},this.colorRects.push({selectColorRect:()=>t(n,e),updateColor:()=>r(n,e)})}this.highlightModeButton("emissive"),this.colorRects[1].selectColorRect()}highlightModeButton(e){const t=e=>Object.values(document.getElementsByClassName("guify-button")).filter((t=>t.innerHTML.includes("Mode")&&t.innerHTML.toLowerCase().includes(e)))[0];t(this.currentMode).classList.remove("mode-button-selected"),t(e).classList.add("mode-button-selected")}}let L=null;const A=(e,t,r,i,n,o,s)=>({type:"range",folder:L,label:e,min:i,max:n,step:o,object:t,property:r,onChange:s}),C=(e,t,r,i)=>({type:"checkbox",folder:L,label:e,object:t,property:r,onChange:i}),_=(e,t,r,i,n)=>({type:"select",folder:L,label:e,object:t,property:r,options:i,onChange:n}),k=(e,t,r,i)=>({type:"text",folder:L,label:e,object:t,property:r,onChange:i}),R=(e,t)=>({type:"button",folder:L,label:e,action:t}),B=(e,t)=>{if(L=e,null!=e)return{type:"folder",label:e,open:t}};class F{constructor(e){le.iMouse.update([0,0,-1,0]);const t=(e,t)=>{const r=se.canvas.getBoundingClientRect();return{x:(e-r.left)/r.width,y:1-(t-r.top)/r.height}},r=(e,r=1)=>{const i=t(e.clientX,e.clientY);le.iMouse.value[0]=i.x,le.iMouse.value[1]=i.y,1===e.buttons&&(le.iMouse.value[2]=r,ae.grid.needsUpdate=!0)},i=e=>{le.iMouse.value[2]=-1};e.addEventListener("mousedown",(e=>{if(le.uLevelStartFinishMode.value>0){const r=t(e.clientX,e.clientY),i=Math.floor(r.x*ae.width),n=Math.floor(r.y*ae.width);1==le.uLevelStartFinishMode.value?le.uLevelStart.update([i,n]):le.uLevelFinish.update([i,n]),le.uLevelStartFinishMode.update(0)}else r(e,0)})),e.addEventListener("mousemove",r),e.addEventListener("mouseup",i),e.addEventListener("mouseleave",i),e.addEventListener("mouseout",i)}}class O{constructor(e,t,r,i){this.width=e,this.height=t,this.colorBuffer=r??new Float32Array(e*t*4),this.stateBuffer=i??new Float32Array(e*t*4),this.needsUpdate=!0}update(){this.needsUpdate&&(this.needsUpdate=!1,this.loadFromGPU())}id(e,t){return 4*(e+t*this.width)}getBlock(e,t){const r=this.id(e,t);return{x:e,y:t,color:this.colorBuffer.slice(r,r+4),state:this.stateBuffer.slice(r,r+4)}}loadFromGPU(){const e=se.fbo.state;oe.bindFramebuffer(oe.FRAMEBUFFER,e.fbo1.framebuffer),oe.readBuffer(oe.COLOR_ATTACHMENT0),oe.readPixels(0,0,this.width,this.height,e.format,e.type,this.colorBuffer),oe.readBuffer(oe.COLOR_ATTACHMENT1),oe.readPixels(0,0,this.width,this.height,e.format,e.type,this.stateBuffer)}prepareForSave(){for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++){const r=4*(t+e*this.width);2==this.stateBuffer[r+0]&&(this.colorBuffer[r+3]>0&&(this.colorBuffer[r+3]*=-1),this.stateBuffer[r+1]=0)}}}var P=r(977),I=r(828);class N{constructor(){this.app=(0,P.ZF)(W),this.db=(0,I.ad)(this.app)}async getAllDocuments(e,t){let r;return r=null!=t?(0,I.IO)((0,I.hJ)(this.db,e),(0,I.Xo)("created","desc"),(0,I.TQ)(t),(0,I.b9)(8)):(0,I.IO)((0,I.hJ)(this.db,e),(0,I.Xo)("created","desc"),(0,I.b9)(8)),await(0,I.PL)(r)}async getDocument(e,t){const r=await(0,I.QT)((0,I.JU)((0,I.hJ)(this.db,e),t));if(!r.exists())throw new Error(`Could not find document ${e}/${t}`);return r.data()}async writeDocument(e,t,r=null){try{return null!=r?await(0,I.pl)((0,I.JU)((0,I.hJ)(this.db,e),r),t):r=await(0,I.ET)((0,I.hJ)(this.db,e),t),r.id}catch(e){console.error("Error adding document: "+e)}return!1}async updateDocument(e,t,r){try{return await(0,I.r7)((0,I.JU)((0,I.hJ)(this.db,e),t),r),!0}catch(e){console.error("Error updating document: "+e)}return!1}async addToArray(e,t,r,i){try{return await(0,I.r7)((0,I.JU)((0,I.hJ)(this.db,e),t),{[r]:(0,I.vr)(i)}),!0}catch(e){console.error("Error adding element to array: "+e)}return!1}}const U=e=>e.split("").map((e=>String.fromCharCode(e.charCodeAt()+15))).join(""),W={[U("RaZ<Vj")]:U("2:kRDj3#I9#cbh?6iI7ED)9VZffXE7;4Y(K@?::"),[U("ac`[VTe:U")]:U("aReYecRTZ_X#Ua]RjXc`f_U")},z=["uHueOffset","uSaturation","uAmbientLight","uLightAngle","uShadowsFalloff","uLevelStart","uLevelFinish"];class H{constructor(e){if(this.firebase=new N,this.gameOver=!1,e)this.load(e);else{this.width=a.width,this.height=a.height;const{default_color_buffer:e,default_state_buffer:t}=this.generateDefaultLevelBuffers();this.grid=new O(this.width,this.height,e,t)}}async load(e){const t=await this.firebase.getDocument(d,e),r=this.stringToBuffer(t.color_buffer),i=this.stringToBuffer(t.state_buffer);this.width=t.width,this.height=t.height,this.grid=new O(t.width,t.height,r,i),this.highscores=(t.highscores??[]).sort(((e,t)=>e.time>t.time?1:-1)),se.editorMode||(le.uLevelStart=new f("uLevelStart"),se.gui.setLevelInfos(t.name,t.author),se.gui.initScoreboard());for(let e of z)null!=t[e]&&null!=le[e]&&le[e].update(t[e]);se.init(),se.player.setPosition(...le.uLevelStart.value)}async save(e,t){const r=this.generatePreviewImageString(512,512);this.grid.prepareForSave();const i=this.bufferToString(this.grid.colorBuffer),n=this.bufferToString(this.grid.stateBuffer),o=z.map((e=>null==le[e]?(console.error("Unknown property: "+e),[e,0]):[e,le[e].value])),s={name:e,author:t,created:(a=new Date,I.EK.fromDate(a)),width:this.width,height:this.height,preview_image:r,color_buffer:i,state_buffer:n,highscores:[],...Object.fromEntries(o)};var a;return await this.firebase.writeDocument(d,s)}async updateHighscores(e){return await this.firebase.addToArray(d,x(),"highscores",{time:this.finishTime-se.timers.levelStart,author:e})}async admin_rewrite(){const e=this.generatePreviewImageString(512,512);this.grid.prepareForSave();const t={preview_image:e,color_buffer:this.bufferToString(this.grid.colorBuffer),state_buffer:this.bufferToString(this.grid.stateBuffer)};return await this.firebase.updateDocument(d,x(),t)}update(){if(this.grid.update(),!se.editorMode&&!this.gameOver){if(y([Math.round(se.player.pos.x),Math.round(se.player.pos.y)],le.uLevelFinish.value)){this.gameOver=!0;const e=Date.now()-se.timers.levelStart,t=this.highscores[Math.min(8,this.highscores.length-1)],r=this.highscores.length<9||e<t.time;this.finishTime=Date.now(),se.gui.setGameOver(!0,e,r)}}}reset(){se.player.setPosition(...le.uLevelStart.value),se.player.setVelocity(0,0),le.uPlayerColor.update([1,1,1]),se.init(),this.gameOver=!1}generateDefaultLevelBuffers(){const e=[],t=[];for(let r=0;r<this.height;r++)for(let i=0;i<this.height;i++){let n=0==i||0==r||i==this.width-1||r==this.width-1?[0,0,0,0]:[1,1,1,-1e-9],o=[0,0,0,0];i==Math.floor(this.width/2)&&r==Math.floor(this.height/2)&&(n=[0,1,0,1]),i==Math.floor(this.width/2)&&2==r&&(n=[1,0,1,1]),i==Math.floor(this.width/2)&&r==this.height-3&&(n=[0,1,1,1]),1===n[3]&&(o[0]=1),e.push(...n),t.push(...o)}return{default_color_buffer:new Float32Array(e),default_state_buffer:new Float32Array(t)}}generatePreviewImageString(e=300,t=300){const r=document.createElement("canvas");r.width=e,r.height=t;const i=r.getContext("2d");let n=le.uLevelStart.value,o=le.uLevelFinish.value,s=le.uLevelStartFinishMode.value;le.uLevelStart.update([-1,-1]),le.uLevelFinish.update([-1,-1]),le.uLevelStartFinishMode.update(-1),se.render(),le.uLevelStart.update(n),le.uLevelFinish.update(o),le.uLevelStartFinishMode.update(s),i.drawImage(se.canvas,0,0,e,t);const a=r.toDataURL("image/jpeg").split(";base64,")[1],l=g.ZP.deflate(a,{to:"string"}),u=String.fromCharCode.apply(null,l);return btoa(u)}bufferToString(e){const t=Array.from(e),r=g.ZP.deflate(JSON.stringify(t),{to:"string"}),i=String.fromCharCode.apply(null,r);return btoa(i)}stringToBuffer(e){const t=atob(e),r=new Uint8Array([...t].map((e=>e.charCodeAt(0)))),i=g.ZP.inflate(r,{to:"string"}),n=JSON.parse(i);return new Float32Array(n)}}const j=2.4,G={x:-1,y:1},q={x:1,y:1},K={x:-1,y:-1},X={x:1,y:-1},J={x:0,y:1},V={x:0,y:-1},Z={x:-1,y:0},$={x:1,y:0},Y={x:1,y:0},Q={x:0,y:1};class ee{constructor(e){this.player=e,this.jumpStart=0,this.lastInput=0,this.jumpCount=0,this.touchesWall=!1,this.lastWallTouch=0}keyDown(){this.jumpCount<2&&(this.touchesWall||Date.now()-this.lastWallTouch<110?(this.jump(),console.log("default jump")):(this.lastInput=Date.now(),console.log("fail jump")))}keyUp(){this.lastInput=0,this.jumpStart=0}onTouchGround(){this.jumpCount=0}jump(){this.jumpStart=Date.now(),this.jumpCount++,this.player.vel.y=.1}setTouchesWall(e){this.touchesWall=e,e&&(this.lastWallTouch=Date.now())}update(e){this.touchesWall&&Date.now()-this.lastInput<120&&(this.jump(),this.lastInput=0),Date.now()-this.jumpStart<200&&(this.player.vel.y+=.9*e)}}class te{keyData={LEFT:!1,RIGHT:!1,UP:!1,DOWN:!1,JUMP:!1};constructor(){this.pos={x:a.uLevelStart[0],y:a.uLevelStart[1]},this.vel={x:0,y:0},this.size=.7,this.jumpState=new ee(this),this.lastSourceActivation=0,window.addEventListener("keydown",(e=>{if(se.gui.isFocusingInputField)return;const t=e.key.toLowerCase();"w"!==t&&"z"!==t&&"arrowup"!==t||this.keyData.UP?"s"!==t||this.keyData.DOWN?"a"!==t&&"q"!==t&&"arrowleft"!==t||this.keyData.LEFT?"d"!==t&&"arrowright"!==t||this.keyData.RIGHT?" "!==t||this.keyData.JUMP||(this.keyData.JUMP=!0,this.jumpState.keyDown()):this.keyData.RIGHT=Date.now():this.keyData.LEFT=Date.now():this.keyData.DOWN=Date.now():this.keyData.UP=Date.now()})),window.addEventListener("keyup",(e=>{const t=e.key.toLowerCase();"w"===t||"z"===t||"arrowup"===t?this.keyData.UP=!1:"s"===t?this.keyData.DOWN=!1:"a"===t||"q"===t||"arrowleft"===t?this.keyData.LEFT=!1:"d"===t||"arrowright"===t?this.keyData.RIGHT=!1:" "===t&&(this.keyData.JUMP=!1,this.jumpState.keyUp())}))}update(e){const t=e=>Math.pow(p((Date.now()-e)/100,0,1),2);se.editorMode&&(this.keyData.UP&&(this.vel.y+=j*e),this.keyData.DOWN&&(this.vel.y-=j*e)),this.keyData.LEFT&&(this.vel.x-=j*e*t(this.keyData.LEFT)),this.keyData.RIGHT&&(this.vel.x+=j*e*t(this.keyData.RIGHT)),this.jumpState.update(e),this.vel.x=p(this.vel.x,-.99,.99),this.vel.y=p(this.vel.y,-.99,.99);const r=e=>e.color[3]>=0||2==e.state[0]&&y(e.color.slice(0,-1),le.uPlayerColor.value);let i=!1;this.vel.x<0?r(this.getNextBlock(G,Y))||r(this.getNextBlock(K,Y))?(this.pos.x=Math.round(this.pos.x)-.5+this.size/2+.001,this.vel.x=0,i=!0):(r(this.getBlock(q,$))||r(this.getBlock(X,$)))&&(i=!0):r(this.getNextBlock(q,Y))||r(this.getNextBlock(X,Y))?(this.pos.x=Math.round(this.pos.x)+.5-this.size/2-.001,this.vel.x=0,i=!0):(r(this.getBlock(G,Z))||r(this.getBlock(K,Z)))&&(i=!0),this.vel.y<=0?(r(this.getNextBlock(K,Q))||r(this.getNextBlock(X,Q)))&&(this.pos.y=Math.round(this.pos.y)-.5+this.size/2+.001,this.vel.y=0,i=!0,this.jumpState.onTouchGround()):r(this.getNextBlock(G,Q))||r(this.getNextBlock(q,Q))?(this.pos.y=Math.round(this.pos.y)+.5-this.size/2-.001,this.vel.y=0,i=!0):(r(this.getBlock(K,V))||r(this.getBlock(X,V)))&&(i=!0),this.jumpState.setTouchesWall(i),this.pos.x+=this.vel.x,this.pos.y+=this.vel.y,this.updateSources(),this.vel.x*=.7,this.vel.y-=.9*e,le.uPlayerData.update(this.createUniformData())}updateSources(){const e=e=>e.color[3]>0||2==e.state[0]&&y(le.uPlayerColor.value,e.color.slice(0,3)),t=(t,r,i)=>{let n=this.getBlock(t,i);return e(n)||(n=this.getBlock(r,i)),e(n)?n:null};let r,i=le.uSourceActive.value;if(le.uSourceActive.update(!1),this.vel.y<0?r=t(K,X,V):this.vel.y>0?r=t(G,q,J):(r=t(K,X,V),r||(r=t(G,q,J))),r||(this.vel.x<0?r=t(G,K,Z):this.vel.x>0?r=t(q,X,$):(r=t(G,K,Z),r||(r=t(q,X,$)))),r){const e=r.color.slice(0,3);le.uPlayerColor.update(e),1==r.state[0]?(le.uSourceActive.update(!0),0==i&&(this.lastSourceActivation=Date.now())):2==r.state[0]&&y(le.uPlayerColor.value,e)&&le.uWireSource.update([r.x,r.y])}r||-1==le.uWireSource.value[0]&&-1==le.uWireSource.value[1]||le.uWireSource.update([-1,-1]),i!==le.uSourceActive.value&&se.editorMode&&(ae.grid.needsUpdate=!0),le.uWireActivationAnimation.update((Date.now()-this.lastSourceActivation)/1e3)}getBlock(e,t){const r=Math.round(this.pos.x+this.size/2*e.x+.02*t.x),i=Math.round(this.pos.y+this.size/2*e.y+.02*t.y);return ae.grid.getBlock(r,i)}getNextBlock(e,t){const r=Math.round(this.pos.x+this.vel.x*t.x+this.size/2*e.x),i=Math.round(this.pos.y+this.vel.y*t.y+this.size/2*e.y);return ae.grid.getBlock(r,i)}createUniformData(){const e=Math.max(1-1.5*Math.abs(this.vel.x),.6),t=Math.max(1-2*Math.max(0,this.vel.y),.6);return[this.pos.x,this.pos.y,this.size/2*e,this.size/2*t]}setPosition(e,t){this.pos.x=e,this.pos.y=t}setVelocity(e,t){this.vel.x=e,this.vel.y=t}}const re="#version 300 es\r\nprecision highp float;\r\n \r\nin vec2 uv;\r\nout vec4 outColor;\r\n\r\nuniform float iTime;\r\nuniform vec2 iResolution;\r\n\r\nuniform vec4 uPlayerData;\r\nuniform vec3 uPlayerColor;\r\n\r\nuniform float uSamples;\r\nuniform float uMaxSteps;\r\nuniform float uAmbientLight;\r\nuniform float uLightAngle;\r\nuniform bool uShadows;\r\nuniform float uShadowsFalloff;\r\nuniform float uFrameBlend;\r\nuniform float uLighting;\r\n\r\nuniform bool uAO;\r\nuniform vec2 uAORange;\r\n\r\nuniform sampler2D tex;\r\nuniform sampler2D col_tex;\r\n\r\n#define SAMPLES     uSamples\r\n#define ITER        uMaxSteps\r\n\r\n#define playerColorIntensityMulitplier 1.\r\n#define exteriorColor vec3(.1,.7,.8)\r\n#define GRID_SIZE vec2(textureSize(col_tex, 0))\r\n\r\n#define is_wall a >= 0.\r\n\r\nfloat hash(vec2 x) { return fract(sin(dot(x, vec2(12.9898,78.233)))*43758.545312); }\r\n\r\nvec2 uniformVector(float rng) {\r\n    float an = rng*6.283185;\r\n    return vec2(sin(an), cos(an));\r\n}\r\n\r\nfloat rectDistance( in vec2 p, in vec2 rad )  {\r\n    vec2 d = abs(p)-rad;\r\n    return length(max(d,0.0)) + min(max(d.x, d.y),0.0);\r\n}\r\n\r\nfloat rectIntersection(vec2 ro, vec2 rd, vec2 rad) {\r\n    vec2 m = 1.0/rd;\r\n    vec2 n = m*ro;\r\n    vec2 k = abs(m)*rad;\r\n    vec2 t1 = -n - k;\r\n    vec2 t2 = -n + k;\r\n\r\n    float tN = max( t1.x, t1.y );\r\n    float tF = min( t2.x, t2.y );\r\n\t\r\n    if( tN>tF || tF<0.0) return 1e9; // no intersection\r\n    \r\n    return tN;\r\n}\r\n\r\n// return true on hit, false if exceeded max iteration count\r\nbool trace(vec2 pos, vec2 map, vec2 rd, inout vec4 data, inout float dist) {\r\n    vec2 deltaDist = abs(1. / rd);\r\n    vec2 rayStep = sign(rd);\r\n    vec2 sideDist = (rayStep * (map - pos + .5) + .5) * deltaDist; \r\n    vec2 mask;\r\n    \r\n    for (float i = 0.; i < ITER; i++) {\r\n        data = texelFetch(col_tex, ivec2(map), 0);\r\n        \r\n        if (data.is_wall) break;\r\n\r\n        mask = sideDist.x < sideDist.y ? vec2(1,0) : vec2(0,1); \r\n        sideDist += mask * deltaDist;\r\n        map += mask * rayStep;\r\n    }\r\n\r\n    if (map.x < 0. || map.y < 0. || map.x >= GRID_SIZE.x || map.y >= GRID_SIZE.y) return false;\r\n\r\n    dist = mask.x == 1. ? sideDist.x - deltaDist.x : sideDist.y - deltaDist.y;\r\n\r\n    float boxDistance = rectIntersection(pos - uPlayerData.xy - .5, rd, vec2(uPlayerData.zw));\r\n    \r\n    if (boxDistance < dist) {\r\n        data = vec4(uPlayerColor*playerColorIntensityMulitplier, 1);\r\n        dist = boxDistance;\r\n    }\r\n    \r\n    return true;\r\n\r\n    // if (i < ITER) return true;\r\n\r\n    // return false;\r\n}\r\n\r\n#define st(a, b, t) mix(a, b, sin(t)*.5+.5)\r\n\r\nvoid main() {\r\n    vec2 u = uv*iResolution/iResolution.y;\r\n    vec2 p = u * min(GRID_SIZE.x, GRID_SIZE.y);\r\n    vec2 id = floor(p);\r\n\r\n    vec2 playerPos = p - uPlayerData.xy - .5;\r\n    float boxDistance = rectDistance(playerPos, vec2(uPlayerData.zw));\r\n\r\n    // Render player block\r\n    if (boxDistance < 0.) {\r\n        outColor = vec4(uPlayerColor + abs(boxDistance)*st(3.,4.,iTime), 1);\r\n        return;\r\n    }\r\n\r\n    vec4 current = texelFetch(col_tex, ivec2(id), 0);\r\n\r\n    // Render emissive blocks\r\n    if (current.is_wall) {\r\n        outColor = vec4(current.rgb * current.a, current.a);\r\n        return;\r\n    }\r\n\r\n    vec3 sumColor = vec3(0);\r\n    float avgDist = 0.;\r\n\r\n    for (float s = 0.; s < SAMPLES; s++) {\r\n        float seed = (s + hash(u+s+mod(iTime,10.))) / SAMPLES;\r\n        vec2 rd = uniformVector(seed);\r\n        \r\n        vec4 data; float dist;\r\n        bool hitObject = trace(p, id, rd, data, dist);\r\n\r\n        if (hitObject) {\r\n            vec3 hitColor = data.rgb; // Wall color\r\n            float em = abs(data.a) * smoothstep(ITER, 0., dist); // Wall emission\r\n\r\n            sumColor += hitColor * em;\r\n            avgDist += dist;\r\n        }\r\n        else\r\n            sumColor += exteriorColor;\r\n    }\r\n\r\n    // Directional shadows\r\n    float shadowIntensity = 1.;\r\n    if (uShadows) {\r\n        vec2 rd = normalize(vec2(cos(uLightAngle), sin(uLightAngle)) + .5*uniformVector(hash(u+mod(iTime,10.)))*uShadowsFalloff);\r\n        \r\n        vec4 data; float dist;\r\n        bool hitObject = trace(p, id, rd, data, dist);\r\n\r\n        if (hitObject) shadowIntensity = smoothstep(0., 10., dist + 4.);\r\n    }\r\n    \r\n    sumColor /= SAMPLES;\r\n    avgDist /= SAMPLES;\r\n\r\n    vec4 last = texture(tex, uv);\r\n\r\n    // Ambient light\r\n    sumColor = min(sumColor + uAmbientLight, vec3(1));\r\n\r\n    // Initial tile color\r\n    sumColor *= mix(current.rgb, vec3(1), .0) * uLighting;\r\n\r\n    // Ambient occlusion\r\n    avgDist = smoothstep(uAORange.x, uAORange.y, avgDist/2.) * .8 + .2;\r\n    if (uAO) sumColor *= avgDist;\r\n    \r\n    // Directional shadows\r\n    sumColor *= mix(shadowIntensity, last.a, uFrameBlend);\r\n\r\n    // Blend with last frame\r\n    vec4 color = mix(vec4(sumColor, shadowIntensity), last, uFrameBlend);\r\n\r\n    outColor = color;//vec4(color, 1);\r\n    outColor = clamp(outColor, vec4(0), vec4(1));\r\n}",ie="#version 300 es\r\nprecision highp float;\r\n \r\nin vec2 uv;\r\nout vec4 outColor;\r\n\r\nuniform float uHueOffset;\r\nuniform float uSaturation;\r\nuniform float uBlockHighlightAnimation;\r\nuniform vec2 uLevelFinish;\r\nuniform vec2 uGridSize;\r\nuniform sampler2D tex;\r\n\r\n#define saturate(v) clamp(v,0.,1.)\r\nvec3 hsv2rgb(vec3 c){\r\n\tvec4 K=vec4(1.,2./3.,1./3.,3.);\r\n\treturn c.z*mix(K.xxx,saturate(abs(fract(c.x+K.xyz)*6.-K.w)-K.x),c.y);\r\n}\r\nvec3 rgb2hsv(vec3 c){\r\n\tvec4 K=vec4(0.,-1./3.,2./3.,-1.),\r\n\t     p=mix(vec4(c.bg ,K.wz),vec4(c.gb,K.xy ),step(c.b,c.g)),\r\n\t     q=mix(vec4(p.xyw,c.r ),vec4(c.r ,p.yzx),step(p.x,c.r));\r\n\tfloat d=q.x-min(q.w,q.y), e=1e-10;\r\n\treturn vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);\r\n}\r\n\r\nvec3 colorCorrection(vec3 col) {\r\n    vec3 c = rgb2hsv(col);\r\n\r\n    c.x += uHueOffset;\r\n    c.y *= uSaturation;\r\n    \r\n    return hsv2rgb(c);\r\n}\r\n\r\nvoid main() {\r\n    vec4 col = texture(tex, uv);\r\n\r\n    col.rgb = colorCorrection(col.rgb);\r\n    col = pow(col, vec4(.69));\r\n\r\n    // Show Level Finish\r\n    vec2 id = uv*uGridSize;\r\n    if (floor(id) == uLevelFinish) {\r\n        vec2 c = floor(id*8.);\r\n        col.rgb = mix(col.rgb, vec3(1,.2,.2), mod(c.x + mod(c.y, 2.), 2.) * uBlockHighlightAnimation);\r\n    }\r\n\r\n    outColor = vec4(col.rgb, 1);\r\n}",ne="#version 300 es\r\nprecision highp float;\r\n \r\nin vec2 uv;\r\nout vec4 outColor;\r\n\r\nuniform float iTime;\r\nuniform vec4 iMouse;\r\n\r\nuniform sampler2D tex;\r\nuniform sampler2D color_tex;\r\nuniform sampler2D state_tex;\r\n\r\n// Level settings\r\nuniform float uHueOffset;\r\nuniform vec2 uGridSize;\r\nuniform float uSaturation;\r\nuniform vec2 uLevelStart;\r\nuniform vec2 uLevelFinish;\r\n\r\n// Level editor\r\nuniform float uBlockHighlightAnimation; // Highlight block animation on mode change\r\nuniform float uDrawMode; // Current draw mode\r\nuniform float uLevelStartFinishMode; // 0: not active, 1: set start, 2: set finish\r\n\r\n#define DRAW_MODE_SOURCE 0.\r\n#define DRAW_MODE_WIRE 1.\r\n#define DRAW_MODE_WALL 2.\r\n#define DRAW_MODE_BACKGROUND 3.\r\n\r\n#define saturate(v) clamp(v,0.,1.)\r\nvec3 hsv2rgb(vec3 c){\r\n\tvec4 K=vec4(1.,2./3.,1./3.,3.);\r\n\treturn c.z*mix(K.xxx,saturate(abs(fract(c.x+K.xyz)*6.-K.w)-K.x),c.y);\r\n}\r\nvec3 rgb2hsv(vec3 c){\r\n\tvec4 K=vec4(0.,-1./3.,2./3.,-1.),\r\n\t     p=mix(vec4(c.bg ,K.wz),vec4(c.gb,K.xy ),step(c.b,c.g)),\r\n\t     q=mix(vec4(p.xyw,c.r ),vec4(c.r ,p.yzx),step(p.x,c.r));\r\n\tfloat d=q.x-min(q.w,q.y), e=1e-10;\r\n\treturn vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);\r\n}\r\n\r\nvec3 colorCorrection(vec3 col) {\r\n    vec3 c = rgb2hsv(col);\r\n\r\n    c.x += uHueOffset;\r\n    c.y *= uSaturation;\r\n    \r\n    return hsv2rgb(c);\r\n}\r\n\r\nvoid main() {\r\n    vec4 col = texture(tex, uv);\r\n\r\n    col.rgb = colorCorrection(col.rgb);\r\n    col = pow(col, vec4(.69));\r\n\r\n    vec2 id = floor(uv*uGridSize);\r\n    vec4 color_data = texelFetch(color_tex, ivec2(id), 0);\r\n    vec4 state_data = texelFetch(state_tex, ivec2(id), 0);\r\n\r\n    // Manage draw mode (source, wire, wall, background)\r\n    if (uDrawMode == DRAW_MODE_SOURCE && state_data.r == 1.)\r\n        col = mix(vec4(1,0,0,1), col, step(mod(min(uBlockHighlightAnimation, .7), .2), .1));\r\n    else if (uDrawMode == DRAW_MODE_WIRE && state_data.r == 2.)\r\n        col = mix(vec4(color_data.rgb, 1), col, .3+.7*smoothstep(0., 1., abs(uBlockHighlightAnimation*2.-.7)));\r\n    else if (uDrawMode == DRAW_MODE_WALL && color_data.a == 0.)\r\n        col = mix(vec4(1), col, .5+.5*smoothstep(0., 1., abs(uBlockHighlightAnimation*2.-.7)));\r\n    else if (uDrawMode == DRAW_MODE_BACKGROUND && color_data.a < 0. && state_data.r == 0.) {\r\n        col = mix(vec4(color_data.rgb, 1), col, .5+.5*smoothstep(0., 1., abs(uBlockHighlightAnimation*2.-.7)));\r\n    }\r\n\r\n    // Render level start\r\n    if (id == uLevelStart && uLevelStartFinishMode != 1. || uLevelStartFinishMode == 1. && floor(iMouse.xy*uGridSize) == id) {\r\n        vec2 c = floor(uv * uGridSize * 8.);\r\n        col.rgb = mix(col.rgb, vec3(.2,1,.2), mod(c.x + mod(c.y, 2.), 2.));\r\n    }\r\n    // Render level finish\r\n    if (id == uLevelFinish && uLevelStartFinishMode != 2. || uLevelStartFinishMode == 2. && floor(iMouse.xy*uGridSize) == id) {\r\n        vec2 c = floor(uv * uGridSize * 8.);\r\n        col.rgb = mix(col.rgb, vec3(1,.2,.2), mod(c.x + mod(c.y, 2.), 2.));\r\n    }\r\n\r\n    outColor = vec4(col.rgb, 1);\r\n}";let oe,se,ae;window.onload=async function(){const e=document.getElementsByTagName("canvas")[0],t=x();se=new ue(e,t==null),null!=t&&await ae.load(t);e.style.visibility="visible",se.update()};let le={};class ue{constructor(e,t=!1){se=this,this.canvas=e,this.editorMode=t,this.settings={...l},oe=e.getContext("webgl2"),oe.getExtension("EXT_color_buffer_float"),oe.getExtension("WEBGL_draw_buffers"),e.width=this.settings.renderWidth,e.height=this.settings.renderHeight,this.level=ae=new H,this.player=new te,this.uniforms=le={},this.init(),this.gui=new w,this.editorMode?this.mouseManager=new F(e):(le.iMouse.update([-1,-1,-1,-1]),le.uBlockHighlightAnimation.update(2),this.gui.updateBlockHighlightAnimation())}init(){this.fbo={state:new s(this.level.width,this.level.height,[this.level.grid.colorBuffer,this.level.grid.stateBuffer]),trace:new s(this.settings.renderWidth,this.settings.renderHeight)},this.programs={state:new v({fragmentSource:"#version 300 es\r\nprecision highp float;\r\n \r\nin vec2 uv;\r\nlayout(location = 0) out vec4 outColor;\r\nlayout(location = 1) out vec4 outState;\r\n\r\nuniform float iTime;\r\nuniform vec2 iResolution;\r\nuniform vec4 iMouse;\r\n\r\nuniform vec3 uColor;\r\nuniform float uEmission;\r\nuniform float uState;\r\nuniform vec4 uPlayerData;\r\nuniform vec3 uPlayerColor;\r\nuniform bool uSourceActive; // True when the user touches a source block (used to trigger wires)\r\nuniform vec2 uWireSource; // Position of the wire currently touched by the player\r\nuniform float uWireActivationAnimation; // Cascade animation effect when the user touches a source block\r\n\r\n#define uWireActivationAnimationSpeed 70.\r\n\r\nuniform sampler2D tex;\r\nuniform sampler2D state_tex;\r\n\r\nfloat hash12(vec2 p) {\r\n\tvec3 p3  = fract(vec3(p.xyx) * .1031);\r\n    p3 += dot(p3, p3.yzx + 33.33);\r\n    return fract((p3.x + p3.y) * p3.z);\r\n}\r\nvec3 hash32(vec2 p) {\r\n\tvec3 p3 = fract(vec3(p.xyx) * vec3(.1031, .1030, .0973));\r\n    p3 += dot(p3, p3.yxz+33.33);\r\n    return fract((p3.xxy+p3.yzz)*p3.zyx);\r\n}\r\nvec3 randomRGB() {\r\n    float h = hash12(uv*iResolution+1.);\r\n    if (h < .33) return vec3(1,0,0);\r\n    else if (h < .66) return vec3(0,1,0);\r\n    return vec3(0,0,1);\r\n}\r\n\r\n// color_buffer\r\n// r, g, b\r\n// a: emissive, < 0: not wall, >= 0: wall\r\n#define EMISSIVE_WALL 1.\r\n#define EMISSIVE_NOT_WALL -1.\r\n#define NOT_EMISSIVE_WALL 0.\r\n#define NOT_EMISSIVE_NOT_WALL -1e-9\r\n\r\n// state_buffer\r\n// r: type (0: none, 1: source, 2: wire)\r\n// g: player-initiated activation (0: not activated, 1-4 direction of source, 5: source)\r\n\r\nvoid init(inout vec4 color, inout vec4 state) {\r\n    vec2 F = floor(uv * iResolution);\r\n\r\n    // Background\r\n    color = vec4(1, 1, 1, NOT_EMISSIVE_NOT_WALL);\r\n    state = vec4(0);\r\n\r\n    // Borders\r\n    if (F.x == 0. || F.y == 0. || F.x == iResolution.x-1. || F.y == iResolution.y-1.) {\r\n        color = vec4(0, 0, 0, NOT_EMISSIVE_WALL);\r\n    }\r\n    // Random emissive tiles\r\n    else if (hash12(uv*iResolution) < .05) {\r\n        color = vec4(randomRGB(), EMISSIVE_WALL);\r\n        state.r = 1.;\r\n    }\r\n}\r\n\r\nconst ivec2 n_offsets[4] = ivec2[4]( ivec2(-1, 0), ivec2(0, 1), ivec2(1, 0), ivec2(0, -1));\r\n\r\nfloat checkNeighbors(ivec2 p) {\r\n    for (int i = 0; i < 4; i++) {\r\n            ivec2 n = p + n_offsets[i];\r\n            vec4 ncolor = texelFetch(tex, n, 0);\r\n            vec4 nstate = texelFetch(state_tex, n, 0);\r\n\r\n            if (ncolor.a > 0. &&               // Emissive wall\r\n                ncolor.rgb == uPlayerColor &&  // Same color as player\r\n                nstate.g > 0.                  // Activated via user\r\n                && (i != (int(nstate.g)-1+2)%4||nstate.g==5.) // Not the same direction as neighbour incoming signal\r\n            ) \r\n                return float(i+1);\r\n    }\r\n\r\n    return -1.;\r\n}\r\n\r\nvoid main() {\r\n    vec4 color = texture(tex, uv);\r\n    vec4 state = texture(state_tex, uv);\r\n\r\n    // Mouse input\r\n    bool drawPixel = floor(iMouse.xy*iResolution) == floor(uv * iResolution) && iMouse.z >= 0.;\r\n    if (drawPixel) {\r\n        color = vec4(uColor, uEmission);\r\n        state = vec4(uState, 0, 0, 0);\r\n        // outColor = color;\r\n        // outState = state;\r\n        // return;\r\n    }  \r\n\r\n    // if (iTime < .2)\r\n    //     init(color, state);\r\n\r\n    if (state.r == 2.) { // Manage wires\r\n\r\n        vec2 F = floor(uv*iResolution);\r\n        \r\n        // Update source\r\n        if (F == uWireSource && color.rgb == uPlayerColor && color.a < 0.) {\r\n            color.a = -color.a;\r\n            state.g = 5.;\r\n        }\r\n\r\n        // Update from neigbors\r\n        float n = checkNeighbors(ivec2(uv * iResolution));\r\n        if (color.rgb == uPlayerColor && color.a < 0. && n >= 0.) {\r\n            color.a = -color.a;\r\n            state.g = n;\r\n        }  \r\n\r\n        // Wire not activated from a neighbor\r\n        if (state.g == 0.) {\r\n            // Activate if source active and color match and wire not active\r\n            if (uSourceActive && color.rgb == uPlayerColor && color.a < 0. && \r\n                length(uPlayerData.xy - F) < uWireActivationAnimation * uWireActivationAnimationSpeed) {\r\n                // Activate wire\r\n                color.a = -color.a;\r\n            }\r\n            // Deactivate if it was active but no source active or color doesnt match anymore\r\n            else if ((!uSourceActive || (color.rgb != uPlayerColor)) && color.a > 0.) {\r\n                color.a = -color.a;\r\n            }\r\n        }\r\n        else if (state.g < 5.) {\r\n            // Check if neigbor still active\r\n            ivec2 n = ivec2(uv * iResolution) + n_offsets[int(state.g)-1];\r\n            vec4 ncolor = texelFetch(tex, n, 0);\r\n            if (ncolor.a <= 0.) {\r\n                color.a = -color.a;\r\n                state.g = 0.;\r\n            }\r\n        }\r\n\r\n        // Deactivate source\r\n        if (state.g == 5.) {\r\n            if (uWireSource == vec2(-1)) {\r\n                color.a = -color.a;\r\n                state.g = 0.;\r\n            }\r\n        }\r\n    }\r\n        \r\n    outColor = color;\r\n    outState = state;\r\n}\r\n",framebuffer:this.fbo.state,textures:{}}),trace:new v({fragmentSource:re,framebuffer:this.fbo.trace,textures:{tex:this.fbo.trace,col_tex:this.fbo.state}}),render:new v({fragmentSource:this.editorMode?ne:ie,textures:{tex:this.fbo.trace}})},this.timers={levelStart:Date.now(),lastFrame:Date.now()-1e3/60},this.uniforms.uGridSize&&this.uniforms.uGridSize.update([this.level.width,this.level.height])}update(){this.render(),requestAnimationFrame(this.update.bind(this))}render(){const e=Date.now(),t=e-this.timers.levelStart;this.uniforms.iTime.update(t/1e3),this.editorMode&&this.gui.drawSettings.update(),this.programs.state.textures.tex=this.fbo.state.getCurrentTexture(),this.programs.state.textures.state_tex=this.fbo.state.getCurrentTexture(1),this.programs.state.exec(),this.fbo.state.swap(),this.programs.trace.exec(),this.fbo.trace.swap(),this.programs.render.textures.color_tex=this.fbo.state.getCurrentTexture(),this.programs.render.textures.state_tex=this.fbo.state.getCurrentTexture(1),this.programs.render.exec(),this.level.gameOver||(this.level.update(),this.player.update(Math.min(1/60,(e-this.timers.lastFrame)/1e3)),this.timers.lastFrame=e,this.editorMode||this.gui.updateTimer(t),this.editorMode&&0===le.iMouse.value[2]&&(le.iMouse.value[2]=1))}updateRenderSize(e,t){this.settings.renderWidth=e,this.settings.renderHeight=t,this.canvas.width=e,this.canvas.height=t,this.fbo.trace=new s(this.settings.renderWidth,this.settings.renderHeight),this.programs.trace=new v({fragmentSource:re,framebuffer:this.fbo.trace,textures:{tex:this.fbo.trace,col_tex:this.fbo.state}}),this.programs.render=new v({fragmentSource:this.editorMode?ne:ie,textures:{tex:this.fbo.trace}})}}}},r={};function i(e){var n=r[e];if(void 0!==n)return n.exports;var o=r[e]={exports:{}};return t[e](o,o.exports,i),o.exports}i.m=t,e=[],i.O=(t,r,n,o)=>{if(!r){var s=1/0;for(c=0;c<e.length;c++){for(var[r,n,o]=e[c],a=!0,l=0;l<r.length;l++)(!1&o||s>=o)&&Object.keys(i.O).every((e=>i.O[e](r[l])))?r.splice(l--,1):(a=!1,o<s&&(s=o));if(a){e.splice(c--,1);var u=n();void 0!==u&&(t=u)}}return t}o=o||0;for(var c=e.length;c>0&&e[c-1][2]>o;c--)e[c]=e[c-1];e[c]=[r,n,o]},i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={757:0};i.O.j=t=>0===e[t];var t=(t,r)=>{var n,o,[s,a,l]=r,u=0;if(s.some((t=>0!==e[t]))){for(n in a)i.o(a,n)&&(i.m[n]=a[n]);if(l)var c=l(i)}for(t&&t(r);u<s.length;u++)o=s[u],i.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return i.O(c)},r=self.webpackChunk_2d_gi_playground=self.webpackChunk_2d_gi_playground||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var n=i.O(void 0,[673,200],(()=>i(624)));n=i.O(n)})();